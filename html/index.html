<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>Covid data Belgium</title>
  <script src="./hammerjs.js"></script>
  <script src="./moment.min.js"></script>
  <script src="./Chart.min.js"></script>
  <script src="./chartjs-plugin-annotation.js"></script>
  <script src="./chartjs-plugin-zoom.min.js"></script>
  <style>
    html {
        font-family: sans-serif;
        font-size: 62.5%;
    }

    body {
        font-size: 2rem;
        line-height: 1.4;
    }

    * {
        font-family: inherit;
        font-size: inherit;
        line-height: inherit;
    }

    a,
    a:visited {
        color: inherit;
    }

    .buttons {
      font-size: 2rem;
      display: flex;
      flex-direction: row;
      align-items: center;
      justify-content: center;
      margin: 2rem 0;
    }
    .buttons button {
      margin: 0 1rem;
    }
    .buttons [data-state="off"] {
      color: #cdcdcd;
    }

    .totals {
      font-size: 2rem;
      display: flex;
      flex-direction: row;
      align-items: center;
      justify-content: center;
    }

    .total {
      position: relative;
      flex: 1;
      min-height: 10rem;
      border: solid 1px;
      margin: 1rem;
      display: flex;
      align-items: center;
      justify-content: center;
      text-align: center;
    }

    .last {
      position: absolute;
      right: 0;
      bottom: 0;
      color: #ffffff;
      padding: 10px;
    }

    .total .last {
      background-color: #333333;
    }

    .total-in .last {
      background-color: #990000;
    }
    .total-in {
      color: #990000;
    }

    .total-out .last {
      background-color: #009900;
    }
    .total-out {
      color: #009900;
    }

    .total-deceased .last {
      background-color: #000099;
    }
    .total-deceased {
      color: #000099;
    }


    .info p {
      text-align: center;
    }
  </style>
</head>

<body>
  <div class="totals">
    <div class="total total-in">
      <p>People In<br><span class='num'><span></p>
      <span class='last'><span>
    </div>
    <div class="total total-out">
      <p>People out<br><span class='num'><span></p>
      <span class='last'><span>
    </div>
    <div class="total total-delta">
      <p>People in hospital (d)<br><span class='num'><span></p>
      <span class='last'><span>
    </div>
    <div class="total total-deceased">
      <p>People deceased<br><span class='num'><span></p>
      <span class='last'><span>
    </div>
    <div class="total total-tests">
      <p>People tested<br><span class='num'><span></p>
      <span class='last'><span>
    </div>
    <div class="total total-infected">
      <p>People infected<br><span class='num'><span></p>
      <span class='last'><span>
    </div>
  </div>

  <div class="info">
    <p>From 2020-03-15 to <span class="end-date">2020-04-05</span>.</p>
    <p>Data source: <a href="https://epistat.wiv-isp.be/Covid/">https://epistat.wiv-isp.be/Covid/</a></p>
  </div>

  <div class="buttons">
    <button data-series="0,1" data-state="on">Toggle In/Out</button>
    <button data-series="2,3" data-state="on">Toggle Hospital</button>
    <button data-series="4" data-state="on">Toggle Deceased</button>
    <button data-series="5,6,7" data-state="off">Toggle Tested/Infected</button>
  </div>

  <div class="chart-container">
    <canvas id="canvas"></canvas>
    <button id="reset-zoom">Reset zoom</button>
  </div>
</body>

<script>

window.onload = function() {
  function addData(data) {
    var totalIn = 0;
    var totalOut = 0;
    var totalDelta = 0;
    var totalDeceased = 0;
    var totalTests = 0;
    var totalInfected = 0;

    var lastIn = 0;
    var lastOut = 0;
    var lastDeceased = 0;
    var lastTests = 0;
    var lastInfected = 0;
    var lastInfected5 = [];
    var lastInfected5Average = 0;

    var maxDelta = 0;

    // Default end date is yesterday.
    var endDate = formatDate(Date.now() - 86400000);
    var lastDate = '';

    var dataLabels = [];
    var dataPointsIn = [];
    var dataPointsOut = [];
    var dataPointsInOut = [];
    var dataPointsInOutColors = [];
    var dataPointsDelta = [];
    var dataPointsHospital = [];
    var dataPointsDeceased = [];
    var dataPointsTests = [];
    var dataPointsInfected = [];
    var dataPointsInfectedDaily = [];

    for (var row in data) {
      // Ignore future dates.
      if (row > endDate) {
        continue;
      }

      dataLabels.push(row);

      dataPointsIn.push({
        x: new Date(row),
        y: data[row].in
      });

      dataPointsOut.push({
        x: new Date(row),
        y: data[row].out
      });

      dataPointsInOut.push({
        x: new Date(row),
        y: data[row].in - data[row].out
      });
      dataPointsInOutColors.push(data[row].in > data[row].out ? 'red' : 'green');

      dataPointsDelta.push({
        x: new Date(row),
        y: data[row].delta + totalDelta
      });

      dataPointsHospital.push({
        x: new Date(row),
        y: data[row].total_in
      });

      if (typeof data[row].deceased != 'undefined') {
        dataPointsDeceased.push({
          x: new Date(row),
          y: data[row].deceased + totalDeceased
        });
      }

      dataPointsTests.push({
        x: new Date(row),
        y: data[row].tests + totalTests
      });

      dataPointsInfected.push({
        x: new Date(row),
        y: data[row].infected + totalInfected
      });

      dataPointsInfectedDaily.push({
        x: new Date(row),
        y: data[row].infected //lastInfected5Average != 0 ? data[row].infected / lastInfected5Average : 1.8
      });

      lastDate = row;
      lastIn = data[row].in;
      lastOut = data[row].out;
      lastDeceased = data[row].deceased || lastDeceased;
      lastTests = data[row].tests;
      lastInfected = data[row].infected ? data[row].infected : 0;

      lastInfected5.push(lastInfected);
      lastInfected5 = lastInfected5.slice(Math.max(lastInfected5.length - 5, 0));
      lastInfected5Average = lastInfected5.reduce((a, b) => a + b, 0) / lastInfected5.length;

      totalIn += data[row].in;
      totalOut += data[row].out;
      totalDelta += data[row].delta;
      totalDeceased += data[row].deceased || 0;
      totalTests += data[row].tests;
      totalInfected += data[row].infected ? data[row].infected : 0;

      maxDelta = Math.max(maxDelta, data[row].delta + totalDelta);
    }

    endDate = lastDate;

    var barChartData = {
      labels: dataLabels,
      datasets: [
        {
          label: 'People In',
          backgroundColor: '#990000',
          borderColor: '#990000',
          borderWidth: 1,
          yAxisID: 'y-axis-1',
          data: dataPointsIn
        },
        {
          label: 'People out',
          backgroundColor: '#009900',
          borderColor: '#009900',
          borderWidth: 1,
          yAxisID: 'y-axis-1',
          data: dataPointsOut
        },
        {
          label: 'People in/out',
          backgroundColor: dataPointsInOutColors,
          borderColor: '#9e9e9e',
          borderWidth: 1,
          yAxisID: 'y-axis-1',
          data: dataPointsInOut
        },
        {
          label: 'Hospital (delta)',
          type: 'line',
          backgroundColor: '#333333',
          borderColor: '#333333',
          borderWidth: 1,
          fill: false,
          yAxisID: 'y-axis-2',
          data: dataPointsDelta
        },
        {
          label: 'Hospital (total)',
          type: 'line',
          backgroundColor: '#656565',
          borderColor: '#656565',
          borderWidth: 1,
          fill: false,
          yAxisID: 'y-axis-2',
          data: dataPointsHospital
        },
        {
          label: 'Deceased',
          type: 'line',
          backgroundColor: '#000099',
          borderColor: '#000099',
          borderWidth: 1,
          fill: false,
          yAxisID: 'y-axis-2',
          data: dataPointsDeceased
        },
        {
          label: 'Tested',
          type: 'line',
          backgroundColor: '#009999',
          borderColor: '#009999',
          borderWidth: 1,
          fill: false,
          yAxisID: 'y-axis-3',
          data: dataPointsTests,
          hidden: true
        },
        {
          label: 'Infected',
          type: 'line',
          backgroundColor: '#009999',
          borderColor: '#009999',
          borderWidth: 1,
          fill: false,
          yAxisID: 'y-axis-3',
          data: dataPointsInfected,
          hidden: true
        },
        {
          label: 'People infected',
          type: 'bar',
          backgroundColor: '#999900',
          borderColor: '#999900',
          borderWidth: 1,
          fill: false,
          yAxisID: 'y-axis-1',
          data: dataPointsInfectedDaily,
          hidden: true
        }
      ]
    };

    var ctx = document.querySelector('.chart-container canvas').getContext('2d');
    const ticks = [10, 100, 1000, 5000, 10000, 20000, 40000, 80000];

    window.myChart = new Chart(ctx, {
      type: 'bar',
      data: barChartData,
      options: {
        responsive: true,
        legend: {
          position: 'top',
        },
        title: {
          display: false
        },
        scales: {
          xAxes: [{
            type: 'time',
            time: {
              unit: 'day',
              distribution: 'linear'
            }
          }],
          yAxes: [
            {
              type: 'linear',
              beginAtZero: true,
              display: true,
              position: 'left',
              id: 'y-axis-1',
            },
            {
              type: 'logarithmic',
              display: true,
              position: 'right',
              id: 'y-axis-2',
              gridLines: {
                drawOnChartArea: false
              },
              ticks: {
                beginAtZero: true,
                callback: function (value, index, values) {
                  if (ticks.includes(value)){
                    return Number(value.toString());
                  }
                }
              },
              afterBuildTicks: function(chart) {
                chart.ticks.push(...ticks);
              }
            },
            {
              type: 'linear',
              beginAtZero: true,
              display: true,
              position: 'right',
              id: 'y-axis-3',
            }
          ],
        },
        annotation: {
          annotations: [{
            type: 'line',
            mode: 'horizontal',
            scaleID: 'y-axis-2',
            value: maxDelta,
            borderColor: 'rgb(75, 192, 192)',
            borderWidth: 2,
            label: {
              enabled: false,
              content: 'Max in hospital'
            }
          }]
        },
        plugins: {
          zoom: {
            zoom: {
              enabled: true,
              drag: true,
              mode: 'xy'
            }
          }
        }
      }
    });

    document.querySelector('.total-in .num').innerText = totalIn;
    document.querySelector('.total-out .num').innerText = totalOut;
    document.querySelector('.total-delta .num').innerText = totalIn - totalOut;
    document.querySelector('.total-deceased .num').innerText = totalDeceased;
    document.querySelector('.total-tests .num').innerText = totalTests;
    document.querySelector('.total-infected .num').innerText = totalInfected;

    document.querySelector('.total-in .last').innerText = (lastIn > 0 ? '+' : '') + lastIn;
    document.querySelector('.total-out .last').innerText = (lastOut > 0 ? '+' : '') + lastOut;
    document.querySelector('.total-delta .last').innerText = ((lastIn - lastOut) > 0 ? '+' : '') + (lastIn - lastOut);
    document.querySelector('.total-deceased .last').innerText = (lastDeceased > 0 ? '+' : '') + lastDeceased;
    document.querySelector('.total-tests .last').innerText = (lastTests > 0 ? '+' : '') + lastTests;
    document.querySelector('.total-infected .last').innerText = (lastInfected > 0 ? '+' : '') + lastInfected;

    document.querySelector('.info .end-date').innerText = endDate;

    // Bind buttons.
    let buttons = document.querySelectorAll('.buttons button');
    buttons.forEach(b => b.addEventListener('click', toggleButton));
  }

  toggleButton = function(event) {
    let button = event.target;
    let indexes = button.getAttribute('data-series').split(',');
    let state = button.getAttribute('data-state');

    indexes.forEach(i => window.myChart.data.datasets[i].hidden = (state == 'on'));

    window.myChart.update();
    button.setAttribute('data-state', state == 'off' ? 'on' : 'off');
  }

  formatDate = function (date) {
    var d = new Date(date),
      month = '' + (d.getMonth() + 1),
      day = '' + d.getDate(),
      year = d.getFullYear();

    if (month.length < 2) {
      month = '0' + month;
    }

    if (day.length < 2) {
      day = '0' + day;
    }

    return [year, month, day].join('-');
  }

  document.getElementById('reset-zoom').addEventListener('click', function () {
    window.myChart.resetZoom();
  });

  fetch('./data.json')
    .then(response => {
      if (response.ok) {
        return response.json();
      }

      throw new Error('Unable to load data.');
    })
    .then(json => {
      addData(json);
    });
}

</script>